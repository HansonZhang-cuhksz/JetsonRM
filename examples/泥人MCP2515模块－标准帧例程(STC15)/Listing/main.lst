C51 COMPILER V9.00   MAIN                                                                  06/02/2014 20:05:18 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE INCDIR(.\BSP\Delay;.\BSP\UART;.\BSP\MCP2515) DEBUG OBJE
                    -CTEXTEND PRINT(.\Listing\main.lst) OBJECT(.\Output\main.obj)

line level    source

   1          /**********************************************************************************
   2           * ¹¤³ÌÃû  £ºÄàÈËMCP2515Ä£¿é£­±ê×¼Ö¡Àı³Ì
   3           * ÃèÊö    £ºµçÄÔÍ¨¹ı"´®¿Úµ÷ÊÔÖúÊÖ"Èí¼ş¸øµ¥Æ¬»ú´®¿Ú1·¢ËÍÊı¾İ£¬´®¿Ú1½ÓÊÕµ½Êı¾İºó
   4           *                       ÔÙÍ¨¹ıCANÄ£¿é·¢ËÍµ½ÁíÒ»¸öCANÄ£¿é£»Í¬Ê±CANÄ£¿é½ÓÊÕµ½µÄCANÊı¾İÍ¨¹ıµ¥
   5           *                       Æ¬»ú´®¿Ú1·¢ËÍµ½µçÄÔ¡£  
   6           * ÊµÑéÆ½Ì¨£ºNiRen_STC/IAP15ºËĞÄ°å(»òÓÃ»§STC15µ¥Æ¬»ú¿ª·¢°å) + NiRen_MCP2515 CANÄ£¿é
   7           * Ó²¼şÁ¬½Ó£º  P2^3 -> MCP2515_SCK              SPIÊ±ÖÓÒı½Å 
   8           *                         P2^2 -> MCP2515_MOSI         SPIÖ÷»úÊä³ö´Ó»úÊäÈëÒı½Å 
   9           *                         P2^1 -> MCP2515_MISO         SPIÖ÷»úÊäÈë´Ó»úÊä³öÒı½Å 
  10           *                         P2^0 -> MCP2515_CS           SPIÆ¬Ñ¡Òı½Å 
  11           *                         P3^3 -> MCP2515_INT          MCP2515ÖĞ¶ÏÒı½Å 
  12           * ×÷Õß    £ºÄàÈËÍ¨ĞÅÄ£¿é¿ª·¢ÍÅ¶Ó
  13           * ²©¿Í    £ºhttp://nirenelec.blog.163.com
  14           * ÌÔ±¦    £ºhttp://nirenelec.taobao.com
  15           * ÉùÃ÷    : ±¾DEMO³ÌĞòÖ»×÷²Î¿¼£¬²»ÄÜÖ±½ÓÓÃµ½Êµ¼ÊÏîÄ¿ÖĞ£¬ÓÃµ½Êµ¼ÊÏîÄ¿ÖĞÔòĞèÒª×ÔĞĞĞŞ¸Ä
  16          **********************************************************************************/
  17          
  18          /*********************************************************************************/
  19          /*×¢Òâ£º±¾Àı³ÌÊÇ»ùÓÚSTC15ÏµÁĞ×îĞÂÔöÇ¿ĞÍ51µ¥Æ¬»ú±àĞ´£¬ÓÉÓÚ²»Í¬ÏµÁĞ51µ¥Æ¬»úÒ»Ğ©ÍâÉè*/
  20          /*¹¦ÄÜÅäÖÃ´æÔÚ²îÒì£¬ÇëÇ×ÃÇÔÚÊ¹ÓÃÊ±¶ÔÓ¦½øĞĞĞŞ¸Ä¡£*/
  21          /*********************************************************************************/
  22          
  23          #include "STC15F2Kxx.h"
  24          #include "MCP2515.H"
  25          
  26          #define FOSC 11059200L                  //ÏµÍ³ÆµÂÊ
  27          #define T1MS (65536-FOSC/1000)  //¶¨Ê±Æ÷¹¤×÷ÔÚ1TÄ£Ê½ÏÂ¶¨Ê±1msµÄ¼ÆÊıÆ÷Öµ(Ğ´ÈëTHx¡¢TLxµÄÖµ)
  28          #define BAUD 9600                               //´®¿Ú1²¨ÌØÂÊ
  29          #define UART1_Rx_Buff_LEN 100   //´®¿Ú1Êı¾İ»º³åÇøÊı¾İ³¤¶È
  30          
  31          bit busy=0;                                                                                     //´®¿Ú1·¢ËÍÊı¾İÃ¦±êÖ¾Î»
  32          unsigned char UART1_Rx_Buffer[UART1_Rx_Buff_LEN];       //´®¿Ú1½ÓÊÕ±£´æ»º³åÇø
  33          unsigned char Uart1_Delay=0;                                            //´®¿Ú1½ÓÊÕÊı¾İÖ¡ÑÓÊ±(ms)£¬ÑÓÊ±Ê±¼äµ½µ±1Ö¡Êı¾İ½ÓÊÕÍê³É
  34          unsigned char Uart1_Write_Count=0;                                      //Ğ´´®¿Ú1»º³åÇøÖ¸Õë
  35          unsigned char Uart1_Read_Count=0;                                       //¶Á´®¿Ú1»º³åÇøÖ¸Õë
  36          unsigned char Uart1_Finish=0;                                           //µ±Ç°Ò»Ö¡Êı¾İ½ÓÊÕÍê³É±êÖ¾
  37          
  38          unsigned char CAN_Flag=0;                                                       //CAN½ÓÊÕµ½Êı¾İ±êÖ¾
  39          unsigned char CAN_R_Buffer[8];                                          //CAN½ÓÊÕÊı¾İ±£´æ»º³åÇø
  40          
  41          /*******************************************************************************
  42          * º¯ÊıÃû  : Timer0_Init
  43          * ÃèÊö    : ¶¨Ê±Æ÷0³õÊ¼»¯ÅäÖÃ
  44          * ÊäÈë    : ÎŞ
  45          * Êä³ö    : ÎŞ
  46          * ·µ»ØÖµ  : ÎŞ
  47          * ËµÃ÷    : ÎŞ
  48          *******************************************************************************/
  49          void Timer0_Init(void)
  50          {
  51   1          AUXR |= 0x80;               //¶¨Ê±Æ÷0Îª1TÄ£Ê½
  52   1          TMOD = 0x00;                //ÉèÖÃ¶¨Ê±Æ÷ÎªÄ£Ê½0(16Î»×Ô¶¯ÖØ×°ÔØ)
  53   1          TL0 = T1MS;                 //³õÊ¼»¯¼ÆÊ±Öµ
  54   1          TH0 = T1MS >> 8;
C51 COMPILER V9.00   MAIN                                                                  06/02/2014 20:05:18 PAGE 2   

  55   1          TR0 = 1;                    //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
  56   1          ET0 = 1;                    //Ê¹ÄÜ¶¨Ê±Æ÷0ÖĞ¶Ï
  57   1          EA = 1;                             //Ê¹ÄÜ×ÜÖĞ¶Ï                                                    
  58   1      }
  59          
  60          /*******************************************************************************
  61          * º¯ÊıÃû  : Timer0_ISR
  62          * ÃèÊö    : ¶¨Ê±Æ÷0ÖĞ¶Ï·şÎñº¯Êı
  63          * ÊäÈë    : ÎŞ
  64          * Êä³ö    : ÎŞ
  65          * ·µ»ØÖµ  : ÎŞ
  66          * ËµÃ÷    : ±¾³ÌĞòÓÃÓÚ¼ì²â1Ö¡´®¿ÚÊı¾İ½ÓÊÕÍê³É
  67          *******************************************************************************/
  68          void Timer0_ISR() interrupt 1 using 1
  69          {
  70   1              if(Uart1_Delay>0)
  71   1              {
  72   2                      Uart1_Delay--;
  73   2                      if(Uart1_Delay==0)
  74   2                      {
  75   3                              //ÑÓÊ±Ê±¼äµ½ÔÙÃ»ÓĞ½ÓÊÕµ½ĞÂµÄ´®¿ÚÊı¾İ£¬±íÊ¾1Ö¡Êı¾İ½ÓÊÕÍê³É
  76   3                              if(Uart1_Write_Count != Uart1_Read_Count) Uart1_Finish=1;
  77   3                      }
  78   2              }
  79   1      }
  80          
  81          /*******************************************************************************
  82          * º¯ÊıÃû  : Exint1_Init
  83          * ÃèÊö    : Íâ²¿ÖĞ¶Ï1³õÊ¼»¯º¯Êı
  84          * ÊäÈë    : ÎŞ
  85          * Êä³ö    : ÎŞ
  86          * ·µ»ØÖµ  : ÎŞ
  87          * ËµÃ÷    : ÎŞ
  88          *******************************************************************************/
  89          void Exint1_Init(void)
  90          {
  91   1          PX1=1;              //ÉèÖÃÍâ²¿ÖĞ¶Ï1µÄÖĞ¶ÏÓÅÏÈ¼¶Îª¸ßÓÅÏÈ¼¶
  92   1          IT1 = 1;    //ÉèÖÃINT1µÄÖĞ¶ÏÀàĞÍ (1:½öÏÂ½µÑØ 0:ÉÏÉıÑØºÍÏÂ½µÑØ)
  93   1          EX1 = 1;    //Ê¹ÄÜINT1ÖĞ¶Ï
  94   1          EA = 1;     //Ê¹ÄÜ×ÜÖĞ¶Ï
  95   1      }
  96          
  97          
  98          /*******************************************************************************
  99          * º¯ÊıÃû  : Exint1_ISR
 100          * ÃèÊö    : Íâ²¿ÖĞ¶Ï1ÖĞ¶Ï·şÎñº¯Êı
 101          * ÊäÈë    : ÎŞ
 102          * Êä³ö    : ÎŞ
 103          * ·µ»ØÖµ  : ÎŞ
 104          * ËµÃ÷    : ÓÃÓÚ¼ì²âMCP2515ÖĞ¶ÏÒı½ÅµÄÖĞ¶ÏĞÅºÅ
 105          *******************************************************************************/
 106          void Exint1_ISR(void) interrupt 2 using 1
 107          {
 108   1              CAN_Flag=1;//CAN½ÓÊÕµ½Êı¾İ±êÖ¾
 109   1      }
 110          
 111          /*******************************************************************************
 112          * º¯ÊıÃû  : UART1_Init_Config
 113          * ÃèÊö    : UART1³õÊ¼»¯ÅäÖÃ
 114          * ÊäÈë    : ÎŞ
 115          * Êä³ö    : ÎŞ
 116          * ·µ»ØÖµ  : ÎŞ
C51 COMPILER V9.00   MAIN                                                                  06/02/2014 20:05:18 PAGE 3   

 117          * ËµÃ÷    : ÎŞ
 118          *******************************************************************************/
 119          void UART1_Init_Config(void)
 120          {
 121   1          P_SW1 &= 0x3f;                                      //ÉèÖÃ´®¿Ú1ÔÚ(P3.0/RxD, P3.1/TxD)
 122   1          SCON = 0x50;                                        //8Î»UART,¿É±ä²¨ÌØÂÊ,ÔÊĞí´®ĞĞ½ÓÊÕ
 123   1              AUXR &= 0xfe;                                   //¶¨Ê±Æ÷1Îª1TÄ£Ê½       
 124   1          AUXR |= 0x40;                                       //¶¨Ê±Æ÷1Îª1TÄ£Ê½
 125   1              TMOD &= 0xF0;                                   //¶¨Ê±Æ÷1ÎªÄ£Ê½0(16Î»×Ô¶¯ÖØÔØ)
 126   1          TL1 = (65536 - (FOSC/4/BAUD));      //ÉèÖÃ²¨ÌØÂÊÖØ×°ÖµµÄµÍ8Î»
 127   1          TH1 = (65536 - (FOSC/4/BAUD))>>8;//ÉèÖÃ²¨ÌØÂÊÖØ×°ÖµµÄ¸ß8Î»
 128   1          TR1 = 1;                                            //Æô¶¯¶¨Ê±Æ÷1¼ÆÊı
 129   1          ES = 1;                                                     //Ê¹ÄÜ´®¿ÚÖĞ¶Ï
 130   1          EA = 1;                                                     //Ê¹ÄÜ×ÜÖĞ¶Ï
 131   1      }
 132          
 133          /*******************************************************************************
 134          * º¯ÊıÃû  : UART1_Buffer_PntAdd
 135          * ÃèÊö    : ¶Á¡¢Ğ´´®¿Ú1»º³åÇøÖ¸Õë¼Ó1 
 136          * ÊäÈë    : *pnt(Ö¸Ïò´®¿Ú1¶Á¡¢Ğ´´®¿Ú1»º³åÇøÖ¸Õë)
 137          * Êä³ö    : ÎŞ
 138          * ·µ»ØÖµ  : ÎŞ
 139          * ËµÃ÷    : ÎŞ
 140          *******************************************************************************/
 141          void UART1_Buffer_PntAdd(unsigned char *pnt)
 142          {
 143   1              *pnt+=1;
 144   1              if(*pnt >= UART1_Rx_Buff_LEN) *pnt=0;
 145   1      }
 146          
 147          /*******************************************************************************
 148          * º¯ÊıÃû  : UART1_ISR
 149          * ÃèÊö    : UART1ÖĞ¶Ï·şÎñº¯Êı
 150          * ÊäÈë    : ÎŞ
 151          * Êä³ö    : ÎŞ
 152          * ·µ»ØÖµ  : ÎŞ
 153          * ËµÃ÷    : ÎŞ
 154          *******************************************************************************/
 155          void UART1_ISR(void) interrupt 4 using 1
 156          {
 157   1              unsigned char ch;
 158   1              //½ÓÊÕÊı¾İ
 159   1              if(RI)
 160   1              {
 161   2                      RI = 0;//Çå³ıRIÎ»
 162   2                      ch=SBUF;
 163   2                      UART1_Rx_Buffer[Uart1_Write_Count]=ch;  //½«½ÓÊÕµ½µÄÊı¾İĞ´Èë»º³åÇø
 164   2                      UART1_Buffer_PntAdd(&Uart1_Write_Count);//Ğ´´®¿Ú1»º³åÇøÖ¸Õë¼Ó1                  
 165   2                      if(Uart1_Write_Count == Uart1_Read_Count)//Èç¹û¶Á¡¢Ğ´»º³åÇøÖ¸ÕëÖØµş,Ôò¶ÁÖ¸Õë¼Ó1,ÕâÊ±½«¶ªÊ§1¸ö×Ö½ÚÊı¾İ
 166   2                      {
 167   3                              UART1_Buffer_PntAdd(&Uart1_Read_Count);//¶Á´®¿Ú1»º³åÇøÖ¸Õë¼Ó1
 168   3                      }
 169   2                      Uart1_Delay = 20;//´®¿Ú1½ÓÊÕÊı¾İÖ¡ÑÓÊ±(ms)£¬ÑÓÊ±Ê±¼äµ½µ±1Ö¡Êı¾İ½ÓÊÕÍê³É
 170   2              }
 171   1              //·¢ËÍÊı¾İ
 172   1              if (TI)                 
 173   1              {
 174   2                      TI = 0;         //Çå³ıTIÎ»
 175   2                      busy = 0;       //ÇåÃ¦±êÖ¾(1Ã¦,0¿ÕÏĞ)
 176   2              }
 177   1      }
 178          
C51 COMPILER V9.00   MAIN                                                                  06/02/2014 20:05:18 PAGE 4   

 179          /*******************************************************************************
 180          * º¯ÊıÃû  : UART1_SendData
 181          * ÃèÊö    : UART1·¢ËÍÒ»¸ö×Ö½Ú
 182          * ÊäÈë    : dat£º´ı·¢ËÍÊı¾İ
 183          * Êä³ö    : ÎŞ
 184          * ·µ»ØÖµ  : ÎŞ
 185          * ËµÃ÷    : ÎŞ
 186          *******************************************************************************/
 187          void UART1_SendData(unsigned char dat)
 188          {
 189   1          while (busy);       //µÈ´ıÇ°ÃæµÄÊı¾İ·¢ËÍÍê³É
 190   1          busy = 1;           //´®¿Ú1·¢ËÍÊı¾İÃ¦±êÖ¾Î»(1Ã¦,0¿ÕÏĞ)
 191   1          SBUF = dat;         //Ğ´Êı¾İµ½UARTÊı¾İ¼Ä´æÆ÷
 192   1      }
 193          
 194          /*******************************************************************************
 195          * º¯ÊıÃû  : UART1_SendBuffer
 196          * ÃèÊö    : UART1·¢ËÍÒ»¸ö»º³åÇøÊı¾İ
 197          * ÊäÈë    : *buff£º´ı·¢ËÍ»º³åÇøÊ×µØÖ·,len£º´ı·¢ËÍÊı¾İ³¤¶È
 198          * Êä³ö    : ÎŞ
 199          * ·µ»ØÖµ  : ÎŞ
 200          * ËµÃ÷    : ÎŞ
 201          *******************************************************************************/
 202          void UART1_SendBuffer(unsigned char *buff,unsigned int len)
 203          {
 204   1              unsigned int i=0;
 205   1      
 206   1              if(len<=0) return;
 207   1      
 208   1              do
 209   1              {
 210   2                      UART1_SendData(buff[i++]);//·¢ËÍµ±Ç°×Ö·û
 211   2              }while(i<len);
 212   1      }
 213          
 214          /*******************************************************************************
 215          * º¯ÊıÃû  : CAN_Send_Dispose
 216          * ÃèÊö    : CAN·¢ËÍ´®¿Ú1½ÓÊÕµ½µÄÊı¾İ´¦Àíº¯Êı
 217          * ÊäÈë    : ÎŞ
 218          * Êä³ö    : ÎŞ
 219          * ·µ»ØÖµ  : ÎŞ
 220          * ËµÃ÷    : ÎŞ
 221          *******************************************************************************/
 222          void CAN_Send_Dispose(void)
 223          {
 224   1              unsigned char i=0,len=0,write=0,buff[8];
 225   1              
 226   1              write = Uart1_Write_Count;
 227   1              if(Uart1_Write_Count<Uart1_Read_Count) write+=UART1_Rx_Buff_LEN;
 228   1              
 229   1              if((write-Uart1_Read_Count) >= 8)//Èç¹û´®¿Ú1½ÓÊÕ»º³åÇøÖĞÎ´¶ÁÊı¾İ´óÓÚ8¸ö×Ö½Ú,ÔòÍ¨¹ıCAN×ÜÏß·¢ËÍ8¸ö×Ö½ÚÊı¾İ(
             -CAN·¢ËÍÒ»Ö¡±¨ÎÄ×î´ó8¸ö×Ö½Ú)
 230   1              {                       
 231   2                      len = 8;                                                        
 232   2              }
 233   1              else if(Uart1_Finish == 1)//Èç¹û´®¿Ú1½ÓÊÕ»º³åÇøÖĞÎ´¶ÁÊı¾İĞ¡ÓÚ8¸ö×Ö½Ú,ÇÒÔÙÒ²Ã»½ÓÊÕµ½´®¿ÚµÄÊı¾İ,ÔòCAN·¢ËÍÊ£
             -ÓàµÄÊı¾İ
 234   1              {
 235   2                      len = write-Uart1_Read_Count;
 236   2                      Uart1_Finish=0;//µ±Ç°Ò»Ö¡Êı¾İ½ÓÊÕÍê³É±êÖ¾                       
 237   2              }
 238   1              else return;//Èç¹û´®¿Ú1½ÓÊÕ»º³åÇøÖĞÎ´¶ÁÊı¾İĞ¡ÓÚ8¸ö×Ö½Ú,ÇÒ»¹ÔÚ½ÓÊÕ´®¿ÚµÄÊı¾İÔòCANÏÈ²»·¢Êı¾İ,µÈ¹»8¸ö×Ö½ÚÁËÔ
C51 COMPILER V9.00   MAIN                                                                  06/02/2014 20:05:18 PAGE 5   

             -Ù·¢
 239   1      
 240   1              for(i=0;i<len;i++)
 241   1              {
 242   2                      buff[i] = UART1_Rx_Buffer[Uart1_Read_Count];//½«´®¿Ú½ÓÊÕ»º³åÇøµÄÊı¾İ¸´ÖÆµ½CAN·¢ËÍÁÙÊ±»º³åÇøbuff
 243   2                      UART1_Buffer_PntAdd(&Uart1_Read_Count);//¶Á´®¿Ú1»º³åÇøÖ¸Õë¼Ó1
 244   2              }       
 245   1              CAN_Send_Buffer(buff,len);//CAN·¢ËÍÖ¸¶¨³¤¶ÈµÄÊı¾İ
 246   1      }
 247          
 248          /*******************************************************************************
 249          * º¯ÊıÃû  : main
 250          * ÃèÊö    : Ö÷º¯Êı£¬ÓÃ»§³ÌĞò´Ómainº¯Êı¿ªÊ¼ÔËĞĞ
 251          * ÊäÈë    : ÎŞ
 252          * Êä³ö    : ÎŞ
 253          * ·µ»ØÖµ  : ÎŞ
 254          * ËµÃ÷    : ÎŞ
 255          *******************************************************************************/
 256          void main(void)
 257          {
 258   1              Timer0_Init();                  //¶¨Ê±Æ÷0³õÊ¼»¯ÅäÖÃ
 259   1              UART1_Init_Config();    //UART1³õÊ¼»¯ÅäÖÃ
 260   1              Exint1_Init();                  //Íâ²¿ÖĞ¶Ï1³õÊ¼»¯º¯Êı
 261   1              MCP2515_Init();                 //MCP2515³õÊ¼»¯ÅäÖÃ
 262   1                                      
 263   1              while(1)
 264   1              {
 265   2                      if(Uart1_Write_Count != Uart1_Read_Count)//Èç¹û¶ÁÖ¸Õë²»µÈĞ´Ö¸Õë,ÔòÖ¤Ã÷´®¿Ú1½ÓÊÕµ½Êı¾İ
 266   2                      {
 267   3                              CAN_Send_Dispose();//CAN·¢ËÍ´®¿Ú1½ÓÊÕµ½µÄÊı¾İ´¦Àíº¯Êı
 268   3                      }
 269   2                      else if(Uart1_Finish == 1) Uart1_Finish = 0;
 270   2                      
 271   2                      while((CAN_Flag==1) || ((P3&0x08) == 0))        
 272   2                      {
 273   3                              unsigned char len; 
 274   3                              
 275   3                              CAN_Flag=0;//CAN½ÓÊÕµ½Êı¾İ±êÖ¾  
 276   3                              len = CAN_Receive_Buffer(CAN_R_Buffer);//CAN½ÓÊÕÒ»Ö¡Êı¾İ
 277   3                              if(len != 0)                                    
 278   3                              UART1_SendBuffer(CAN_R_Buffer,len);//UART1·¢ËÍÒ»¸ö»º³åÇøÊı¾İ
 279   3                      }       
 280   2              }
 281   1      }
 282          
 283          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    520    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    113      15
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
